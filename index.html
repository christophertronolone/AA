<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA Companion - Literature & Guidance</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FIX: Use Global/Compat Firebase Scripts for wider compatibility (local/GitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* Custom styles for the mobile screen container */
        body {
            background-color: #f3f4f6;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* The main "phone" container */
        #app-container {
            width: 100%;
            max-width: 400px; /* Standard phone width */
            height: 100vh; /* Full height on mobile */
            max-height: 800px; /* Max height for desktop preview */
            background-color: white;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 2rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Custom color palette - AA colors (Indigo theme) */
        .color-primary-dark {
            background-color: #4338CA; /* Indigo 700 */
        }
        .text-primary-dark {
            color: #4338CA;
        }
        
        /* Styling for the new Top Navigation Tabs */
        #top-nav .nav-button {
             padding-bottom: 8px; /* Space for the underline */
             transition: color 0.2s, border-color 0.2s;
             flex-grow: 1; /* Distribute space evenly */
        }
        #top-nav .nav-button.active {
            color: white; 
            border-bottom: 2px solid white; /* Highlight line */
        }
        #top-nav .nav-button:not(.active) {
            color: #a5b4fc; /* Indigo 300 for contrast */
        }


        /* Custom scrollbar for content area */
        .scrollable-content {
            /* No bottom padding needed anymore */
            padding-bottom: 1.5rem; 
        }
        .scrollable-content::-webkit-scrollbar {
            width: 4px;
        }
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #818cf8; /* Indigo 300 for scrollbar */
            border-radius: 2px;
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- Header/Navigation Bar - All navigation elements are now consolidated here -->
    <div class="color-primary-dark text-white p-6 pb-0 rounded-b-3xl relative">
        <!-- 1. Top Title Bar (Title + Settings) -->
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold">AA Companion</h1>
                <p class="text-sm opacity-75">Daily Guidance</p>
            </div>
            <!-- Settings Icon (Placeholder) -->
            <button class="p-2 rounded-full hover:bg-white/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44C9.76 2 8.78 3.09 8.81 4.54L9 6h6l.19-1.46C15.22 3.09 14.24 2 12.22 2z"/><path d="M12 21a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2z"/><path d="M12 6v14"/></svg>
            </button>
        </header>

        <!-- 2. Search AA Literature Input -->
        <div class="bg-white p-3 rounded-xl shadow-lg flex items-center mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <input type="text" id="searchInput" placeholder="Search AA Literature..." class="w-full text-gray-800 focus:outline-none placeholder-gray-400">
        </div>

        <!-- 3. Top Tabs (Navigation Buttons) -->
        <div id="top-nav" class="flex justify-around items-end pt-2">
            <button class="flex flex-col items-center justify-center p-2 nav-button active" data-view="homeView">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs mt-1">Home</span>
            </button>
            <button class="flex flex-col items-center justify-center p-2 nav-button" data-view="stepsView">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H7"/><path d="M19 19H5"/><path d="M14 12H10"/></svg>
                <span class="text-xs mt-1">Steps</span>
            </button>
            <button class="flex flex-col items-center justify-center p-2 nav-button" data-view="traditionsView">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                <span class="text-xs mt-1">Traditions</span>
            </button>
            <button class="flex flex-col items-center justify-center p-2 nav-button" data-view="searchResultsView">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-xs mt-1">Search</span>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="content" class="flex-grow p-6 scrollable-content overflow-y-auto">
        <!-- Home View (Default) -->
        <div id="homeView" class="view">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Daily Reading</h2>

            <!-- Daily Meditation Card -->
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 mb-6">
                <div class="flex items-center text-primary-dark mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                    <span id="currentDate" class="font-medium text-sm"></span>
                </div>
                <h3 class="text-lg font-extrabold text-gray-900 mb-3">The Serenity Prayer</h3>
                <p id="dailyMeditationText" class="text-gray-600 leading-relaxed whitespace-pre-wrap">
                    <!-- Content populated by script -->
                </p>
            </div>
            
            <!-- Daily Thought Card -->
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-100 mb-6">
                <h3 class="text-lg font-extrabold text-gray-900 mb-3 border-b pb-2 border-gray-100">A Thought for the Day</h3>
                
                <p id="jftText" class="text-gray-700 leading-relaxed text-sm font-semibold italic">
                    <!-- Content populated by script -->
                </p>
            </div>
            
        </div>

        <!-- Steps View -->
        <div id="stepsView" class="view hidden">
            <h2 class="text-2xl font-extrabold text-primary-dark mb-4">The Twelve Steps of AA</h2>
            <div id="stepsContent" class="bg-white p-5 rounded-xl shadow-md border border-gray-100 text-gray-700 whitespace-pre-wrap"></div>
        </div>

        <!-- Traditions View -->
        <div id="traditionsView" class="view hidden">
            <h2 class="text-2xl font-extrabold text-primary-dark mb-4">The Twelve Traditions of AA</h2>
            <div id="traditionsContent" class="bg-white p-5 rounded-xl shadow-md border border-gray-100 text-gray-700 whitespace-pre-wrap"></div>
        </div>

        <!-- Search Results View -->
        <div id="searchResultsView" class="view hidden">
            <h2 class="text-2xl font-extrabold text-primary-dark mb-4">Search Results</h2>
            <div id="searchResults" class="space-y-4">
                <p id="noResults" class="text-gray-500 hidden">No excerpts found. Try searching for "sponsor", "alcoholic", or "God".</p>
                <p id="searchInstruction" class="text-gray-500">Type a keyword in the search bar above to find relevant literature excerpts.</p>
            </div>
        </div>

    </div>

    <!-- Message Box (Instead of alert()) -->
    <div id="messageBox" class="fixed inset-0 bg-black/50 hidden justify-center items-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-primary-dark mb-3" id="messageTitle"></h3>
            <p class="text-gray-700 mb-4" id="messageText"></p>
            <button id="closeMessageBox" class="w-full bg-primary-dark text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Close</button>
        </div>
    </div>
</div>

<script>
    // --- Firebase Global Instances (Kept for environment compatibility) ---
    // NOTE: These variables are set up to run *without* Firebase functions 
    // when running locally/on GitHub Pages. Firebase data storage will only 
    // work when running inside the Canvas environment.
    let app, db, auth, userId;
    let isAuthReady = false;

    // --- AA Literature Data Definitions (Embedded) ---
    const LITERATURE_DATA = {
        dailyReading: {
            meditation: "God, grant us the serenity\nto accept the things we cannot change,\nCourage to change the things we can,\nand wisdom to know the difference.",
            jft: "When we are honest with ourselves, we realize that we must face our character defects, not run from them. The promises are coming true if we dedicate ourselves to the program. We are no longer alone, and we are no longer victims."
        },
        steps: [
            "1. We admitted we were powerless over alcohol—that our lives had become unmanageable.",
            "2. Came to believe that a Power greater than ourselves could restore us to sanity.",
            "3. Made a decision to turn our will and our lives over to the care of God as we understood Him.",
            "4. Made a searching and fearless moral inventory of ourselves.",
            "5. Admitted to God, to ourselves, and to another human being the exact nature of our wrongs.",
            "6. Were entirely ready to have God remove all these defects of character.",
            "7. Humbly asked Him to remove our shortcomings.",
            "8. Made a list of all persons we had harmed, and became willing to make amends to them all.",
            "9. Made direct amends to such people wherever possible, except when to do so would injure them or others.",
            "10. Continued to take personal inventory and when we were wrong promptly admitted it.",
            "11. Sought through prayer and meditation to improve our conscious contact with God as we understood Him, praying only for knowledge of His will for us and the power to carry that out.",
            "12. Having had a spiritual awakening as the result of these Steps, we tried to carry this message to alcoholics, and to practice these principles in all our affairs."
        ].join('\n\n'),
        traditions: [
            "1. Our common welfare should come first; personal recovery depends upon A.A. unity.",
            "2. For our group purpose there is but one ultimate authority—a loving God as He may express Himself in our group conscience. Our leaders are but trusted servants; they do not govern.",
            "3. The only requirement for A.A. membership is a desire to stop drinking.",
            "4. Each group should be autonomous except in matters affecting other groups or A.A. as a whole.",
            "5. Each group has but one primary purpose—to carry its message to the alcoholic who still suffers.",
            "6. An A.A. group ought never endorse, finance, or lend the A.A. name to any related facility or outside enterprise, lest problems of money, property, or prestige divert us from our primary purpose.",
            "7. Every A.A. group ought to be fully self-supporting, declining outside contributions.",
            "8. Alcoholics Anonymous should remain forever nonprofessional, but our service centers may employ special workers.",
            "9. A.A., as such, ought never be organized; but we may create service boards or committees directly responsible to those they serve.",
            "10. Alcoholics Anonymous has no opinion on outside issues; hence the A.A. name ought never be drawn into public controversy.",
            "11. Our public relations policy is based on attraction rather than promotion; we need always maintain personal anonymity at the level of press, radio, and films.",
            "12. Anonymity is the spiritual foundation of all our Traditions, ever reminding us to place principles before personalities."
        ].join('\n\n'),
        searchExcerpts: [
            // Core Excerpts
            { source: "Big Book, Chapter 5", text: "If we have decided we want to be honest and try the A.A. way, we should have no difficulty at all. It is suggested that we get a **sponsor**.", keywords: ["sponsor", "guidance", "honest"] },
            { source: "Twelve Steps and Twelve Traditions, Step 1", text: "The words 'we admitted' are important, for until a person can admit that he is an **alcoholic** and is powerless, he cannot begin recovery.", keywords: ["alcoholic", "powerless", "admitted"] },
            { source: "Twelve Steps and Twelve Traditions, Tradition 12", text: "**Anonymity** is the spiritual foundation of all our Traditions, ever reminding us to place principles before personalities.", keywords: ["anonymity", "principles"] },
            { source: "Big Book, Chapter 6", text: "We decided to turn our will and our lives over to the care of **God** as we understood Him.", keywords: ["God", "higher power", "will"] },
            { source: "Twelve Steps and Twelve Traditions, Step 10", text: "We continue to take personal inventory and when we were wrong, promptly **admitted** it.", keywords: ["admitted", "inventory", "wrong"] },
            // Expanded Excerpts
            { source: "Big Book, Chapter 5", text: "**Resentment** is the number one offender. It destroys more alcoholics than anything else. From it stem all forms of spiritual disease.", keywords: ["resentment", "offender", "disease", "spiritual"] },
            { source: "Big Book, Chapter 7", text: "Practical experience shows that nothing will so much insure immunity from drinking as intensive **work with other alcoholics**.", keywords: ["service", "work", "help", "others", "immunity"] },
            { source: "Big Book, Chapter 6 (Night Review)", text: "When we retire at night, we constructively review our day. Were we resentful, selfish, dishonest or **afraid**?", keywords: ["afraid", "fear", "review", "night", "dishonest"] },
            { source: "Big Book, Promises", text: "We will comprehend the word **serenity** and we will know peace. No matter how far down the scale we have gone, we will see how our experience can benefit others.", keywords: ["serenity", "peace", "promises", "benefit"] },
            { source: "Motto/Principle", text: "We put '**First Things First**' by attending to our spiritual life every day, knowing that our sobriety depends on it.", keywords: ["first things first", "motto", "sobriety", "spiritual"] },
            { source: "Big Book, Chapter 11", text: "We are not cured of alcoholism. What we really have is a daily **reprieve** contingent on the maintenance of our spiritual condition.", keywords: ["reprieve", "spiritual condition", "cured", "alcoholism"] },
            { source: "Big Book, Chapter 5", text: "There is a solution. Almost none of us liked the self-searching, the leveling of our pride, the confession of shortcomings, but we saw that it worked, and we decided to go through with it.", keywords: ["solution", "pride", "self-searching", "confession"] },
            { source: "Twelve Steps and Twelve Traditions, Tradition 1", text: "Our common **welfare** should come first; personal recovery depends upon A.A. unity.", keywords: ["welfare", "unity", "group"] },
        ]
    };

    // --- Firebase Initialization (Modified for Compatibility) ---
    async function initFirebase() {
        // Fallback for environment variables when not running in the Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(firebaseConfigString);
        } catch (e) {
            console.error("Failed to parse Firebase config. Using empty config.", e);
            firebaseConfig = {};
        }

        // If firebase is not available globally (e.g., if CDN load failed), skip initialization
        if (typeof firebase === 'undefined' || !firebase.initializeApp) {
            console.warn("Firebase scripts not loaded. Running in local, non-persistent mode.");
            userId = crypto.randomUUID(); // Mock ID if no config
            isAuthReady = true;
            return;
        }


        if (Object.keys(firebaseConfig).length === 0) {
            console.warn("Firebase configuration is missing. Running in non-persistent mode.");
            userId = crypto.randomUUID(); 
            isAuthReady = true;
            return;
        }

        try {
            // Use global Firebase functions (compat version)
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore(app);
            auth = firebase.auth(app);

            if (initialAuthToken) {
                await auth.signInWithCustomToken(initialAuthToken);
            } else {
                await auth.signInAnonymously();
            }
            
            userId = auth.currentUser?.uid || crypto.randomUUID();
            isAuthReady = true;
            console.log("Firebase initialized and user signed in:", userId);

        } catch (error) {
            console.error("Error during Firebase initialization or sign-in:", error);
            showMessage("Initialization Error", "Failed to connect or authenticate with the database. Functionality is limited.");
        }
    }
    
    // --- Navigation Functions ---
    const views = {
        homeView: document.getElementById('homeView'),
        stepsView: document.getElementById('stepsView'),
        traditionsView: document.getElementById('traditionsView'),
        searchResultsView: document.getElementById('searchResultsView')
    };
    
    let currentView = 'homeView';

    function showView(viewId) {
        // Hide all views and remove active class from all buttons
        document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
        document.querySelectorAll('.nav-button').forEach(button => button.classList.remove('active'));

        // Show the requested view
        const viewElement = views[viewId];
        if (viewElement) {
            viewElement.classList.remove('hidden');
            currentView = viewId;
        }

        // Set the active button
        const activeButton = document.querySelector(`#top-nav .nav-button[data-view="${viewId}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }

        // Handle specific view setup
        if (viewId === 'stepsView') {
            document.getElementById('stepsContent').textContent = LITERATURE_DATA.steps;
        } else if (viewId === 'traditionsView') {
            document.getElementById('traditionsContent').textContent = LITERATURE_DATA.traditions;
        } else if (viewId === 'searchResultsView') {
            // Ensure search instruction is visible if input is empty
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value.trim().length < 3) {
                 document.getElementById('searchResults').innerHTML = '<p id="searchInstruction" class="text-gray-500">Type a keyword in the search bar above to find relevant literature excerpts.</p>';
            }
        }
    }

    // --- Search Functionality ---
    function performSearch(query) {
        const normalizedQuery = query.toLowerCase().trim();
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = ''; 
        
        // Only trigger search view if query is non-empty and long enough (3 chars minimum)
        if (normalizedQuery.length >= 3) {
            // Automatically switch to search view when typing
            showView('searchResultsView');

            const filteredResults = LITERATURE_DATA.searchExcerpts.filter(item =>
                item.keywords.some(k => k.includes(normalizedQuery)) ||
                item.text.toLowerCase().includes(normalizedQuery)
            );

            if (filteredResults.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-500">No excerpts found. Try searching for "resentment", "fear", or "service".</p>';
                return;
            }

            filteredResults.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.className = 'bg-white p-4 rounded-xl shadow-md border border-gray-100';

                // Highlight the query in the text
                const highlightedText = result.text.replace(
                    new RegExp('(' + normalizedQuery + ')', 'gi'),
                    '<span class="font-bold text-red-600 bg-indigo-100 p-0.5 rounded">$1</span>'
                );

                resultElement.innerHTML = `
                    <h3 class="text-xs font-semibold text-primary-dark mb-1">${result.source}</h3>
                    <p class="text-gray-700 leading-snug">${highlightedText}</p>
                `;
                resultsContainer.appendChild(resultElement);
            });
        } else if (currentView === 'searchResultsView' && normalizedQuery.length === 0) {
            // If the search view is active and the user clears the input, return to Home
            showView('homeView');
        }
    }

    // --- Utility Functions ---

    // Custom Message Box (Replaces alert())
    function showMessage(title, text) {
        document.getElementById('messageTitle').textContent = title;
        document.getElementById('messageText').textContent = text;
        document.getElementById('messageBox').classList.remove('hidden');
        document.getElementById('messageBox').classList.add('flex');
    }

    function hideMessage() {
        document.getElementById('messageBox').classList.add('hidden');
        document.getElementById('messageBox').classList.remove('flex');
    }

    // --- State & Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Set the current date
        const options = { month: 'long', day: 'numeric', year: 'numeric' };
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', options);

        // Populate daily reading content
        document.getElementById('dailyMeditationText').textContent = LITERATURE_DATA.dailyReading.meditation;
        document.getElementById('jftText').textContent = LITERATURE_DATA.dailyReading.jft;
        
        // --- Attach Event Listeners ---

        // 1. Top Navigation Buttons
        document.querySelectorAll('#top-nav .nav-button').forEach(button => {
            button.addEventListener('click', () => {
                // Clear search input if navigating away from search
                if (button.dataset.view !== 'searchResultsView') {
                    document.getElementById('searchInput').value = '';
                }
                showView(button.dataset.view);
            });
        });

        // 2. Search Input (Triggers search and navigates to results)
        document.getElementById('searchInput').addEventListener('input', (e) => {
            performSearch(e.target.value);
        });

        // 3. Message Box Close Button
        document.getElementById('closeMessageBox').addEventListener('click', hideMessage);

        // Initialize Firebase (for environment compatibility)
        initFirebase();
        
        // Show default view
        showView('homeView');
    });

</script>

</body>
</html>
